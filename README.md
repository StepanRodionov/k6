# k6

Описание инструмента

## Запуск

Описание запуска в pipeline проекта

## Запуск локально

Данный инструмент можно запускать локально!
Для этого необходимо сначала установить k6. Сделать это просто: идем на страницу https://k6.io/docs/getting-started/installation/
и следуем короткой инструкции.

Далее запускать нагрузочные тесты можно с помощью команды k6. Подробное описание по команде - `k6 --help`

Для работы и запуска рекомендуется использовать IDE от JetBrains, там есть плагин, упрощающий работу. Далее в инструкции будет описан запуск из IDE.

### Запуск с помощью плагина

Шаги очень простые:
- скачиваем плагин для работы с k6 и включаем его
- создаем Run Configuration в верхнем правом углу окна IDE
- настраиваем требуемые параметры: опции, ENV переменные, путь к скрипту
- жмем Run! В консоли вы увидите вывод утилиты и финальную статистику

Можно не настраивать профили с нуля, а использовать пресеты, которые есть в папке `.run.example` . Чтобы они стали доступны
в окошке конфигураций, необходимо скопировать их в папку .run

Вот так выглядит настройка для локального запуска:
![img.png](img/setup_local.png)

После того как настроили, выбираем сценарий в выпадашке и жмем Run

![img.png](img/run.png)

> Запускать в IDE получится только базовый k6, собранное с расширениями запустить не выйдет

## Профили нагрузки

Данный инструмент поддерживает большое количество профилей нагрузки. В официальной документации
можно найти множество примеров как можно запускать тестирование.
Однако для удобства пользователей, в репозитории настроены базовые сценарии для запуска.

Примечание: все сценарии были запущены с параметрами HOLD=120 и TPS=300

### Линейный

Генерирует константное количество запросов в секунду, которое будет указано в настройке TPS
на протяжении всей работы скрипта.
Может быть опасно применять на больших RPS: приложение не успевает отмасштабироваться и погибает.

Задается через ENV TYPE=linear

![img.png](img/img.png)

### Кривая нормального распределения

Выдает классический "колокол" нормального распределения, достигая максимума запросов в пике

Задается через ENV TYPE=curve

![img.png](img/img1.png)

### Кривая распределения с плато

Является разновидностью нормального распределения, только в отличие от базового сценария
примерно треть времени скрипт работает на максимальном RPS

Задается через ENV TYPE=curve_flat

![img.png](img/img2.png)

### Плавное нарастание

Скрипт постепенно разгоняется до максимальной производительности и
на последней своей трети работает на максимальных RPS

Задается через ENV TYPE=increasing

![img.png](img/img3.png)

### Подключение профиля в скрипт нагруза

Делается двумя строчками кода на JS:
```javascript
const scenarioFun = determineScenario(__ENV.TYPE)
const scenario = scenarioFun(maxVus, tps, duration)
```

### Создание своих профилей нагрузки

Вы всегда можете разрабатывать свои сценарии. Для этого можно использовать как код,
который есть в этом репозитории (см содержимое файла scenarios.js и curveDistribution()),
так и базовые возможности k6 - https://k6.io/docs/using-k6/scenarios/executors/

## Написание своих расширений

### Вводные

Для разработки своих расширений (плагинов) необходимо установить инструмент [xk6](https://github.com/grafana/xk6). 
Это легко сделать, пользуясь официальной документацией. После чего вы сможете собирать бинарник k6 с внешними модулями или своим собственным.

Подробнее вот тут: https://k6.io/docs/extensions/guides/build-a-k6-binary-with-extensions/

> Если у вас возникают проблемы с запуском xk6, выполните в терминале `export PATH=$PATH:$(go env GOPATH)/bin`. 
> Также необходимо включить модули go - `export GO111MODULE="on"`, а еще в проекте созданы файлы go.mod и load.go, без них не запускается
> 
> Вполне возможно, что все шаги выше нафиг не нужны при грамотной настройке

Пример плагина можно найти в папке ./plugins/demo . Пример сборки с локальным модулем demo и внешним модулем sql в Makefile. 
Там же пример запуска локально собранного бинарника

### Как писать свои плагины?

TODO - рекомендации по написанию своих модулей.
Пример кода модуля от k6 - https://github.com/grafana/xk6-sql/blob/master/sql.go

### Как работать с образами в pipeline

Собираем image при помощи Dockerfile из проекта, результатом запуска которого будет образ с готовым бинарником, содержащим оба этих плагина. 
Образ необходимо запушить в registry. Пример действий:

```bash
docker build .
# writing image sha256:8f958d901369be800cb7dcad2752129d5a5ac47c0bd737be6d2d7f196ea98093
docker tag 8f958d901369 registry.ru/namespace/project:tag
docker push registry.ru/namespace/project:tag
```

Сейчас этот образ можно получить в hub.docker.com как [rodionoff/xk6:^0.9](https://hub.docker.com/r/rodionoff/xk6)

Что необходимо сделать дальше:
- добавить стадию сборки образа в pipeline
- пушить образ в registry вашей организации
- скачивать его на стадии запуска нагруза и запускать на нем


